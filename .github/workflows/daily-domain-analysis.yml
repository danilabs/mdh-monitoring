name: ðŸŒ Daily Domain Health Monitoring

on:
  schedule:
    # Run daily at 2:00 AM UTC for comprehensive domain health analysis
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      source_file:
        description: 'Specific pixel data file to analyze (optional - will auto-detect latest if not provided)'
        required: false
        type: string
      workers:
        description: 'Number of concurrent workers for domain analysis'
        required: false
        default: '20'
        type: string
      timeout:
        description: 'Timeout per domain in seconds'
        required: false
        default: '15'
        type: string

permissions:
  contents: write

jobs:
  domain-health-analysis:
    name: ðŸ” Comprehensive Domain Health Assessment
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: ðŸ“¥ Checkout repository with full history
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # Fetch all history to ensure we have all data files
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ Set up Python 3.9 runtime
      uses: actions/setup-python@v6
      with:
        python-version: '3.9'
    
    - name: ðŸ“¦ Install MDH analyzer dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ðŸ“ Prepare reports output directory
      run: mkdir -p reports
    
    - name: ðŸ” Locate most recent pixel tracking data
      id: find-latest
      run: |
        # Find the most recent pixel data file in the data directory
        LATEST_FILE=$(ls -t data/pixel_data_*.json 2>/dev/null | head -n1)
        if [ -z "$LATEST_FILE" ]; then
          echo "No pixel data files found in data directory"
          exit 1
        fi
        echo "latest_file=$LATEST_FILE" >> $GITHUB_OUTPUT
        echo "Found latest pixel data file: $LATEST_FILE"
    
    - name: ðŸš€ Execute comprehensive domain analysis
      env:
        SOURCE_FILE: ${{ inputs.source_file || steps.find-latest.outputs.latest_file }}
        WORKERS: ${{ inputs.workers || '20' }}
        TIMEOUT: ${{ inputs.timeout || '15' }}
      run: |
        echo "ðŸ” Starting comprehensive domain health analysis..."
        echo "ðŸ“ Source file: $SOURCE_FILE"
        echo "âš¡ Concurrent workers: $WORKERS"
        echo "â±ï¸ Timeout per domain: ${TIMEOUT}s"
        echo ""
        
        python -m mdh_analyzer domains "$SOURCE_FILE" \
          --output-dir reports \
          --workers "$WORKERS" \
          --timeout "$TIMEOUT" \
          --verbose
    
    - name: ðŸ“ Generate comprehensive markdown report
      env:
        SOURCE_FILE: ${{ inputs.source_file || steps.find-latest.outputs.latest_file }}
      run: |
        LATEST_REPORT=$(ls -t reports/report_*.json 2>/dev/null | head -n1)
        
        if [ -n "$LATEST_REPORT" ]; then
          echo "ðŸ“Š Generating comprehensive markdown report..."
          echo "ðŸ“ Pixel data source: $SOURCE_FILE"
          echo "ðŸ“‹ Domain analysis data: $LATEST_REPORT"
          echo ""
          
          python -m mdh_analyzer report "$SOURCE_FILE" "$LATEST_REPORT"
          
          echo "âœ… Markdown report generated successfully"
        else
          echo "âŒ No domain analysis report found - cannot generate markdown report"
          exit 1
        fi
    
    - name: âœ… Verify report generation success
      id: check-reports
      run: |
        # Check if any new report files were created (both JSON and MD)
        if [ -n "$(find reports -name 'report_*' -newer '${{ steps.find-latest.outputs.latest_file }}' 2>/dev/null)" ]; then
          echo "new_reports=true" >> $GITHUB_OUTPUT
          echo "New reports generated"
        else
          echo "new_reports=false" >> $GITHUB_OUTPUT
          echo "No new reports generated"
        fi
    
    - name: ðŸ’¾ Commit and publish analysis results
      if: steps.check-reports.outputs.new_reports == 'true'
      env:
        SOURCE_FILE: ${{ steps.find-latest.outputs.latest_file }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --local user.email "mdh-monitoring@danilabs.com"
        git config --local user.name "MDH Monitoring Bot"
        
        # Add new report files (both JSON and MD)
        git add reports/report_*.json reports/report_*.md
        
        # Create detailed commit message with analysis metadata
        TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        REPORT_COUNT=$(ls reports/report_*.json 2>/dev/null | wc -l)
        
        git commit -m "ðŸŒ Daily Domain Health Analysis - $TIMESTAMP

        ðŸ“Š **Analysis Summary:**
        - Source Data: $SOURCE_FILE
        - Reports Generated: $REPORT_COUNT new analysis files
        - Analysis Type: Comprehensive domain health monitoring
        
        ðŸ” **Health Checks Performed:**
        - DNS resolution status verification
        - HTTP/HTTPS availability testing
        - WHOIS registration status checking
        - Multi-threaded processing for efficiency
        
        ðŸ“‹ **Generated Reports:**
        - JSON data files with detailed domain analysis
        - Human-readable markdown summaries
        - Available domains sorted by pixel value
        - Statistical breakdowns and trends
        
        ðŸ¤– Automated by MDH Monitoring Bot"
        
        git push
    
    - name: ðŸ“Š Generate comprehensive execution summary
      if: always()
      env:
        SOURCE_FILE: ${{ steps.find-latest.outputs.latest_file }}
        NEW_REPORTS: ${{ steps.check-reports.outputs.new_reports }}
        WORKERS: ${{ inputs.workers || '20' }}
        TIMEOUT: ${{ inputs.timeout || '15' }}
      run: |
        echo "# ðŸŒ Daily Domain Health Monitoring Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Execution Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "**Source Data:** \`$SOURCE_FILE\`" >> $GITHUB_STEP_SUMMARY
        echo "**Processing Configuration:** $WORKERS workers, ${TIMEOUT}s timeout" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$NEW_REPORTS" == "true" ]; then
          echo "## âœ… Analysis Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count domains analyzed
          LATEST_REPORT=$(ls -t reports/report_*.json 2>/dev/null | head -n1)
          if [ -f "$LATEST_REPORT" ]; then
            DOMAIN_COUNT=$(python3 -c "
        import json
        try:
            with open('$LATEST_REPORT') as f:
                data = json.load(f)
                print(data.get('metadata', {}).get('total_domains', 'Unknown'))
        except:
            print('Unknown')
        " 2>/dev/null || echo "Unknown")
            echo "**Domains Analyzed:** $DOMAIN_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Generated Reports" >> $GITHUB_STEP_SUMMARY
          for report in reports/report_*.json reports/report_*.md; do
            if [ -f "$report" ]; then
              SIZE=$(du -h "$report" | cut -f1)
              echo "- \`$report\` ($SIZE)" >> $GITHUB_STEP_SUMMARY
            fi
          done
        else
          echo "## âŒ Analysis Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No new reports were generated. Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” Analysis Capabilities" >> $GITHUB_STEP_SUMMARY
        echo "- **DNS Health**: Resolution status, NXDOMAIN detection, timeout handling" >> $GITHUB_STEP_SUMMARY
        echo "- **HTTP Availability**: Status code analysis, SSL verification, redirect handling" >> $GITHUB_STEP_SUMMARY
        echo "- **WHOIS Status**: Registration verification, availability detection" >> $GITHUB_STEP_SUMMARY
        echo "- **Performance**: Multi-threaded processing with configurable workers" >> $GITHUB_STEP_SUMMARY
        echo "- **Reporting**: JSON data + human-readable markdown summaries" >> $GITHUB_STEP_SUMMARY
        echo "- **Historical Tracking**: Timestamped snapshots for trend analysis" >> $GITHUB_STEP_SUMMARY